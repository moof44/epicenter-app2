<div class="report-container" [@fadeIn]>
    <div class="report-header">
        <div class="title-group">
            <h1>Monthly Sales Report</h1>
            <p class="helper-text">Daily revenue breakdown and quota performance.</p>
        </div>

        <div class="month-selector">
            <button mat-icon-button (click)="prevMonth()" matTooltip="Previous Month">
                <mat-icon>chevron_left</mat-icon>
            </button>
            <span class="month-display">{{ getMonthName(viewMonth()) }} {{ viewYear() }}</span>
            <button mat-icon-button (click)="nextMonth()" matTooltip="Next Month">
                <mat-icon>chevron_right</mat-icon>
            </button>
        </div>

        <div class="actions">
            <!-- Recalculate Month -->
            <button mat-button (click)="recalculateMonth()" matTooltip="Recalculate this month's data">
                <mat-icon>sync</mat-icon> Recalculate Month
            </button>
            <!-- Hidden utility for admin/dev to backfill everything -->
            <button mat-icon-button (click)="recalculateAll()" matTooltip="Recalculate ALL History (Slow)"
                style="opacity: 0.05">
                <mat-icon>warning</mat-icon>
            </button>
            <button mat-stroked-button (click)="goToSalesByUser()">
                <mat-icon>person</mat-icon> View Sales by User
            </button>
        </div>
    </div>

    <div class="report-content">
        <mat-card class="table-card">
            <table mat-table [dataSource]="report()?.days || []" class="sales-table">
                <!-- Date Column -->
                <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef> Date </th>
                    <td mat-cell *matCellDef="let day"> {{ day.date | date:'MMM dd, yyyy' }} </td>
                </ng-container>

                <!-- Day Name Column -->
                <ng-container matColumnDef="dayName">
                    <th mat-header-cell *matHeaderCellDef> Day </th>
                    <td mat-cell *matCellDef="let day"> {{ getDayName(day.date) }} </td>
                </ng-container>

                <!-- Total Sales Column -->
                <ng-container matColumnDef="totalSales">
                    <th mat-header-cell *matHeaderCellDef class="text-right"> Daily Sales </th>
                    <td mat-cell *matCellDef="let day" class="text-right fw-500"> ₱{{ day.totalSales | number:'1.2-2' }}
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef class="text-right"> </th>
                    <td mat-cell *matCellDef="let day" class="text-right">
                        <button mat-icon-button (click)="recalculateDay(day)" matTooltip="Recalculate this day"
                            color="warn">
                            <mat-icon>sync</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                <!-- Empty State -->
                <tr class="mat-row" *matNoDataRow>
                    <td class="mat-cell text-center py-4" colspan="4">No transactions found for this month.</td>
                </tr>
            </table>
        </mat-card>

        <div class="summary-section">
            <mat-card class="summary-card total-card">
                <mat-card-content>
                    <div class="summary-label">Monthly Total</div>
                    <div class="summary-value main">₱{{ report()?.total || 0 | number:'1.2-2' }}</div>
                </mat-card-content>
            </mat-card>

            <mat-card class="summary-card quota-card">
                <mat-card-content>
                    <div class="summary-label">Monthly Quota</div>
                    <!-- Removing ?. here because settings() is initialized -->
                    <div class="summary-value">₱{{ settings().monthlyQuota | number:'1.2-2' }}</div>

                    <div class="quota-progress-container" *ngIf="settings().monthlyQuota">
                        <div class="progress-info">
                            <span>{{ progress() | number:'1.0-0' }}% Achieved</span>
                            <span class="status-chip" [class.success]="isTargetMet()">
                                {{ isTargetMet() ? 'TARGET MET' : 'IN PROGRESS' }}
                            </span>
                        </div>
                        <mat-progress-bar mode="determinate" [value]="progress()"
                            [color]="isTargetMet() ? 'primary' : 'warn'"></mat-progress-bar>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>
    </div>
</div>