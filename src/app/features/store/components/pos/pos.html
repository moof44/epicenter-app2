<div class="pos-container">
  <!-- Instructional Header -->
  <div class="page-header">
    <h1>Sell Items</h1>
    <p class="helper-text">Ring up customers here. Click items to add them to the cart, or use the categories to filter.
    </p>
  </div>

  <div class="banner-container" *ngIf="!(isShiftOpen$ | async)">
    <div class="warning-banner">
      <mat-icon>lock</mat-icon>
      <span>Register is currently <strong>CLOSED</strong>. Open a shift in Cash Register to make sales.</span>
    </div>
  </div>

  <div class="content-layout">
    <!-- Left: Products Grid -->
    <div class="products-section">
      <!-- Member Search (Optional) -->
      <div class="member-search-bar">
        <mat-form-field appearance="outline" class="search-field full-width">
          <mat-label>Select Member (Optional)</mat-label>
          <mat-icon matPrefix>person_search</mat-icon>
          <input type="text" matInput [formControl]="memberControl" [matAutocomplete]="auto"
            placeholder="Search by name...">
          <button *ngIf="selectedMember()" matSuffix mat-icon-button (click)="clearMember()">
            <mat-icon>close</mat-icon>
          </button>
          <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayMember"
            (optionSelected)="selectMember($event.option.value)">
            <mat-option *ngFor="let member of members$ | async" [value]="member">
              {{ member.name }}
            </mat-option>
          </mat-autocomplete>
          <mat-hint *ngIf="!selectedMember()">Guest / Walk-in</mat-hint>
          <mat-hint *ngIf="selectedMember()">Member: {{ selectedMember()?.name }}</mat-hint>
        </mat-form-field>
      </div>

      <div class="section-header">
        <h2>Items for Sale</h2>
        <mat-chip-listbox [ngModel]="selectedCategory()" (ngModelChange)="selectedCategory.set($event)"
          class="category-filter">
          <mat-chip-option *ngFor="let cat of categories" [value]="cat">
            {{ cat === 'All' ? 'All Items' : cat }}
          </mat-chip-option>
        </mat-chip-listbox>
      </div>

      <div class="products-grid" *ngIf="products$ | async as products">
        <mat-card *ngFor="let product of filterProducts(products)" class="product-card"
          [class.out-of-stock]="product.stock <= 0" [class.disabled-state]="!(isShiftOpen$ | async)"
          (click)="addToCart(product)" [@fadeIn]>
          <div class="product-image">
            <img *ngIf="product.imageUrl" [src]="product.imageUrl" [alt]="product.name">
            <mat-icon *ngIf="!product.imageUrl" class="placeholder-icon">
              {{ getCategoryIcon(product.category) }}
            </mat-icon>
          </div>
          <mat-card-content>
            <h3 class="product-name">{{ product.name }}</h3>
            <p class="product-price">₱{{ product.price | number:'1.2-2' }}</p>
            <p class="product-stock" [class.low]="product.stock < 10">
              Stock: {{ product.stock }}
            </p>
          </mat-card-content>
        </mat-card>

        <div *ngIf="filterProducts(products).length === 0" class="empty-state">
          <mat-icon>inventory_2</mat-icon>
          <p>No products in this category</p>
        </div>
      </div>
    </div>

    <!-- Right: Cart Summary -->
    <div class="cart-section mat-elevation-z4" [class.expanded]="cartExpanded()">
      <div class="cart-header" (click)="toggleCart()" (keydown.enter)="toggleCart()" tabindex="0" role="button">
        <h2>
          <mat-icon>shopping_cart</mat-icon>
          Cart
          <span class="cart-count" *ngIf="(cart$ | async)?.length as count">({{ count }})</span>
        </h2>
        <button mat-icon-button (click)="clearCart(); $event.stopPropagation()" matTooltip="Clear Cart"
          *ngIf="(cart$ | async)?.length" [disabled]="!(isShiftOpen$ | async)">
          <mat-icon>delete_sweep</mat-icon>
        </button>
      </div>

      <div class="cart-items" *ngIf="cart$ | async as cartItems">
        <div *ngIf="cartItems.length === 0" class="empty-cart">
          <mat-icon>remove_shopping_cart</mat-icon>
          <p>Cart is empty</p>
        </div>

        <div *ngFor="let item of cartItems" class="cart-item" [@fadeIn]>
          <div class="item-info">
            <span class="item-name">{{ item.productName }}</span>
            <div class="price-container">
              <span class="original-price" *ngIf="item.isPriceOverridden">
                <del>₱{{ item.originalPrice | number:'1.2-2' }}</del>
              </span>
              <span class="item-price" [class.overridden]="item.isPriceOverridden">
                ₱{{ item.price | number:'1.2-2' }} each
              </span>
              <button mat-icon-button class="edit-price-btn"
                (click)="openPriceOverrideDialog(item); $event.stopPropagation()" [disabled]="!(isShiftOpen$ | async)"
                matTooltip="Override Price">
                <mat-icon>edit</mat-icon>
              </button>
            </div>
          </div>
          <div class="item-controls">
            <button mat-icon-button (click)="updateQuantity(item, -1); $event.stopPropagation()"
              [disabled]="!(isShiftOpen$ | async)">
              <mat-icon>remove</mat-icon>
            </button>
            <span class="quantity">{{ item.quantity }}</span>
            <button mat-icon-button (click)="updateQuantity(item, 1); $event.stopPropagation()"
              [disabled]="!(isShiftOpen$ | async)">
              <mat-icon>add</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="removeItem(item.productId); $event.stopPropagation()"
              [disabled]="!(isShiftOpen$ | async)">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <div class="item-subtotal">₱{{ item.subtotal | number:'1.2-2' }}</div>
        </div>
      </div>

      <div class="cart-footer">
        <div class="cart-total">
          <span>Total:</span>
          <span class="total-amount">₱{{ (cartTotal$ | async) | number:'1.2-2' }}</span>
        </div>
        <button mat-raised-button color="primary" class="checkout-btn" (click)="checkout()"
          [disabled]="isProcessing() || !(cart$ | async)?.length || !(isShiftOpen$ | async)">
          <mat-icon>point_of_sale</mat-icon>
          {{ isProcessing() ? 'Processing...' : 'Checkout' }}
        </button>
      </div>
    </div>
  </div>
</div>