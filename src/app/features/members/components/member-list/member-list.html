<div class="page-header">
    <h1>Members</h1>
    <a mat-raised-button color="primary" routerLink="/members/add">
        <mat-icon>add</mat-icon> Add Member
    </a>
</div>

<div class="filters-container"
    style="display: flex; gap: 16px; padding: 0 16px; margin-bottom: 16px; align-items: center;">
    <mat-form-field appearance="outline" style="flex: 1; max-width: 300px;">
        <mat-label>Search Members</mat-label>
        <input matInput [(ngModel)]="searchQuery" (keyup)="applyFilters()" placeholder="Name or Contact #">
        <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 150px;">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="statusFilter" (selectionChange)="applyFilters()">
            <mat-option value="All">All Status</mat-option>
            <mat-option value="Active">Active</mat-option>
            <mat-option value="Inactive">Inactive</mat-option>
        </mat-select>
    </mat-form-field>
</div>

<div class="mat-elevation-z2 table-container" [@fadeIn]>
    <!-- Loading removed or handled by dataSource logic manually if needed, 
         but MatTableDataSource handles empty arrays gracefully. 
         Spinner can be conditional on an 'isLoading' flag if we added one. 
         For simplicity, keeping it simple. -->

    <table mat-table [dataSource]="dataSource" class="full-width-table mobile-card-table" [@staggerList]
        *ngIf="dataSource.data.length > 0; else emptyState">

        <!-- Name Column -->
        <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef> Name </th>
            <td mat-cell *matCellDef="let member" data-label="Name">
                <div class="member-name">{{ member.name }}</div>
                <div class="member-email">{{ member.contactNumber }}</div>
            </td>
        </ng-container>


        <!-- Remarks Column -->
        <ng-container matColumnDef="remarks">
            <th mat-header-cell *matHeaderCellDef> Remarks </th>
            <td mat-cell *matCellDef="let member" data-label="Remarks">
                <span *ngIf="member.remarks" class="remarks-text" [matTooltip]="member.remarks">
                    <mat-icon class="remark-icon"
                        style="font-size: 18px; height: 18px; width: 18px; vertical-align: middle;">comment</mat-icon>
                </span>
                <span *ngIf="!member.remarks" class="no-remark">-</span>
            </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="membershipStatus">
            <th mat-header-cell *matHeaderCellDef> Status </th>
            <td mat-cell *matCellDef="let member" data-label="Status">
                <mat-chip-set>
                    <mat-chip [color]="member.membershipStatus === 'Active' ? 'accent' : 'warn'" selected>
                        {{ member.membershipStatus | titlecase }}
                    </mat-chip>
                </mat-chip-set>
            </td>
        </ng-container>

        <!-- Expiration Column -->
        <ng-container matColumnDef="membershipExpiration">
            <th mat-header-cell *matHeaderCellDef> Expiration </th>
            <td mat-cell *matCellDef="let member" [class.expired]="isExpired(member)" data-label="Expiration">
                <ng-container *ngIf="member.membershipExpiration?.seconds; else dateObj">
                    {{ member.membershipExpiration.seconds * 1000 | date:'mediumDate' }}
                </ng-container>
                <ng-template #dateObj>
                    {{ member.membershipExpiration | date:'mediumDate' }}
                </ng-template>
            </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Actions </th>
            <td mat-cell *matCellDef="let member" data-label="Actions">
                <a mat-icon-button [routerLink]="['/members', member.id, 'progress']" matTooltip="View Progress"
                    color="primary">
                    <mat-icon>insights</mat-icon>
                </a>
                <a mat-icon-button [routerLink]="['/members/edit', member.id]" matTooltip="Edit Member">
                    <mat-icon>edit</mat-icon>
                </a>
                <button mat-icon-button (click)="toggleStatus(member)"
                    [matTooltip]="member.membershipStatus === 'Active' ? 'Deactivate' : 'Activate'" color="warn">
                    <mat-icon>{{ member.membershipStatus === 'Active' ? 'block' : 'check_circle' }}</mat-icon>
                </button>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <ng-template #emptyState>
        <div class="empty-state">
            <mat-icon class="empty-icon">person_off</mat-icon>
            <p>No members found.</p>
            <a mat-stroked-button color="primary" routerLink="/members/add">Add Member</a>
        </div>
    </ng-template>

    <mat-paginator [pageSizeOptions]="[10, 20, 50]" showFirstLastButtons aria-label="Select page of members">
    </mat-paginator>
</div>